--[[
    Main script that integrates multiple game enhancement modules:
    - Player ESP (Class Colors, Held Item)
    - Trinket ESP (Name only)
    - Auto-Aim system
    - Better Leaderboard
    - Observe UI
    - Chat Log
    - Spell Percentage
    - Walkspeed Control
    - NoFog (Simple)
    - Trans Trail
    - Combo Counter
    - Mob ESP
    - Server Browser
    - Auto Demon Step
    - Auto Potion
    
    Uses LinoriaLib for UI management with theme and save support.
]]

-- ========================================
-- DEPENDENCIES AND LIBRARY SETUP
-- ========================================

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting") -- Kept for NoFog
local TextChatService = game:GetService("TextChatService") -- Added for Chat Log
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService") -- NEW: For Server Browser
local TeleportService = game:GetService("TeleportService") -- NEW: For Server Browser
local ReplicatedStorage = game:GetService("ReplicatedStorage") -- NEW: For Server Join Event

local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:FindFirstChild("PlayerGui") or LocalPlayer:WaitForChild("PlayerGui") -- Ensure playerGui exists

local REPO_BASE_URL = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/refs/heads/main/'
local BRAZIL_HUB_BASE_URL = "https://raw.githubusercontent.com/Rakise/Puppy-Hub/refs/heads/main/"

-- Carrega LinoriaLib
local Library = loadstring(game:HttpGet(REPO_BASE_URL .. 'Library.lua'))() -- Use HTTPS for GitHub Raw

-- Load LinoriaLib components
local ThemeManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(REPO_BASE_URL .. 'addons/SaveManager.lua'))()


-- Safe module loading with pcall
local function safeRequire(url)
    local ok, result = pcall(function()
        -- Use HTTPS for GitHub Raw URLs
        local correctedUrl = url:gsub("http://", "https://") 
        return loadstring(game:HttpGet(correctedUrl))()
    end)
    if ok then
        return result
    else
        warn("[Puppy Hub] Module load error:", url)
        warn("error:", tostring(result))
        return nil
    end
end

-- Helper: Safecall wrapper (for Server Browser)
local function safeCall(func, ...)
	local success, result = pcall(func, ...)
	if not success then
		local trace = debug.traceback()
		warn("PuppyHub safeCall Error:", result, "\nStack Trace:\n" .. trace)
	end
	return success, result
end


-- NEW: Load UtilsService first as other modules depend on it
local UtilsService = safeRequire(BRAZIL_HUB_BASE_URL .. "UtilsService")

-- Load existing main-modules
local PlayerESP = safeRequire(BRAZIL_HUB_BASE_URL .. "PlayerESPHandler")
local AutoAim = safeRequire(BRAZIL_HUB_BASE_URL .. "Auto-Aim")
local BetterLeaderboard = safeRequire(BRAZIL_HUB_BASE_URL .. "betterleaderboard")
local TrinketESP = safeRequire(BRAZIL_HUB_BASE_URL .. "trinket_esp_handler")
local Intent = safeRequire(BRAZIL_HUB_BASE_URL .. "Intent")
local AutoBlock = safeRequire(BRAZIL_HUB_BASE_URL .. "auto_block")
local TriggerMonitor = safeRequire(BRAZIL_HUB_BASE_URL .. "TriggerMonitor")
local PerformanceMonitor = safeRequire(BRAZIL_HUB_BASE_URL .. "PerformanceMonitor")
local Indicator = safeRequire(BRAZIL_HUB_BASE_URL .. "Indicator") -- For Damage Indicators

-- Load new modules
local ObserveUI = safeRequire(BRAZIL_HUB_BASE_URL .. "ObserveUI")
local ChatLog = safeRequire(BRAZIL_HUB_BASE_URL .. "ChatLog")
local SpellPercentage = safeRequire(BRAZIL_HUB_BASE_URL .. "SpellPercentage")
local TransTrail = safeRequire(BRAZIL_HUB_BASE_URL .. "TransTrail")
local ComboCounter = safeRequire(BRAZIL_HUB_BASE_URL .. "ComboCounter")
local MobESP = safeRequire(BRAZIL_HUB_BASE_URL .. "MobESPHandler") -- NEW: Load Mob ESP
local CooldownIndicator = safeRequire(BRAZIL_HUB_BASE_URL .. "CooldownIndicator") -- NEW: Load Cooldown Indicator
local NoFog = safeRequire(BRAZIL_HUB_BASE_URL .. "NoFog") -- NEW: Load simplified NoFog
local AutoDemonStep = safeRequire(BRAZIL_HUB_BASE_URL .. "AutoDemonStep") -- NEW: Load Auto Demon Step
local AutoPotion = safeRequire(BRAZIL_HUB_BASE_URL .. "AutoPotion") -- NEW: Load Auto Potion

-- Load sub-modules
local FOVCircleManager = safeRequire(BRAZIL_HUB_BASE_URL .. "FOVCircleManager")

-- Load util-modules
local ConnectionManager = safeRequire(BRAZIL_HUB_BASE_URL .. "ConnectionManager")
-- local UtilsService = safeRequire(BRAZIL_HUB_BASE_URL .. "UtilsService") -- MOVED TO TOP

local connMgr = ConnectionManager and ConnectionManager.new() or nil

-- Helper para instanciar m贸dulos com seguran莽a
local function safeNew(module, name, ...) -- Added ... for arguments like playerGui
    if module and type(module.new) == "function" then
        local ok, inst = pcall(module.new, ...) -- Pass arguments
        if ok then
            return inst
        else
            warn("[Puppy Hub] Erro ao instanciar m贸dulo:", name, inst)
            return nil
        end
    else
        warn("[Puppy Hub] M贸dulo n茫o carregado ou n茫o possui .new():", name)
        return nil
    end
end


-- Instantiate modules
local ModuleInstances = {
    playerEsp = safeNew(PlayerESP, "PlayerESP"),
    autoAim = safeNew(AutoAim, "AutoAim"),
    betterLeaderboard = safeNew(BetterLeaderboard, "BetterLeaderboard"),
    trinketEsp = safeNew(TrinketESP, "TrinketESP"),
    autoBlock = safeNew(AutoBlock, "AutoBlock"),
    indicator = safeNew(Indicator, "Indicator"),
    mobEsp = safeNew(MobESP, "MobESP"), 
    -- New module instances
    observeUI = safeNew(ObserveUI, "ObserveUI", playerGui), -- Pass playerGui
    chatLog = safeNew(ChatLog, "ChatLog", playerGui),       -- Pass playerGui
    spellPercentage = safeNew(SpellPercentage, "SpellPercentage", playerGui), -- Pass playerGui
    transTrail = safeNew(TransTrail, "TransTrail"),
    comboCounter = safeNew(ComboCounter, "ComboCounter", playerGui), -- Pass playerGui
    cooldownIndicator = safeNew(CooldownIndicator, "CooldownIndicator", playerGui), -- NEW: Instantiate Cooldown Indicator
    noFog = safeNew(NoFog, "NoFog"), -- NEW: Instantiate NoFog
    autoDemonStep = safeNew(AutoDemonStep, "AutoDemonStep"), -- NEW: Instantiate Auto Demon Step
    autoPotion = safeNew(AutoPotion, "AutoPotion"), -- NEW: Instantiate Auto Potion
    -- ServerBrowser is not a module, it's built into the UI tabs
}


-- Verifica se todos os m贸dulos principais foram carregados corretamente
local failedModules = {}
for name, inst in pairs(ModuleInstances) do
    if not inst then
        table.insert(failedModules, name)
    end
end
-- Also check modules loaded directly (like TriggerMonitor, etc.)
if not TriggerMonitor then table.insert(failedModules, "TriggerMonitor") end
if not PerformanceMonitor then table.insert(failedModules, "PerformanceMonitor") end
if not FOVCircleManager then table.insert(failedModules, "FOVCircleManager") end
if not Intent then table.insert(failedModules, "Intent") end


if #failedModules == 0 then
    print("[Puppy Hub] All modules loaded successfully.")
else
    warn("[Puppy Hub] Some modules failed to load:", table.concat(failedModules, ", "))
end

-- ========================================
-- GLOBAL FEATURES STATE (From PuppyAdmin)
-- ========================================
-- This holds the toggle state for your admin features
local features = {
	TrinketEsp = false,
    MobEsp = false, 
	PlayerEsp = true, -- Enable Player ESP by default
	NoFall = false, 
	Configurations = false,
	ShowObserveGui = true, 
	ShowChatLogGui = true, 
	ArtifactNotifier = false, 
	ShowSpellPercentages = false, 
    ShowCooldowns = false, -- NEW
	ShowComboCounter = true, 
	TransTrail = false, 
	
	-- NEW UI Features (flags)
    NoFog = false, -- NEW: Simple toggle
	Walkspeed = 16,
	WalkspeedOverride = false, 
    AutoDemonStep = false, -- NEW
    -- Server Browser toggle is not needed here as it's just a tab
}


-- ========================================
-- MODULE INSTANCES AND CONFIGURATION
-- ========================================

-- Configuration constants
local CONFIG = {
    AUTO_AIM = {
        AVAILABLE_TOOLS = {"Fimbulvetr", "Perflora", "Armis", "Grapple", "Percutiens", "Inferi"},
        DEFAULT_FOV = 20,
        DEFAULT_RANGE = 200,
        DEFAULT_TIME_TO_HIT = 0.15,
        DEFAULT_STUDS_BEHIND = {min = 20, max = 30}
    },
    FOV_CIRCLE = {
        DEFAULT_COLOR = Color3.fromRGB(255, 182, 193), -- Puppy Pink
        STROKE_THICKNESS = 2,
        TRANSPARENCY = 0.3
    },
    PLAYER_ESP = {
        DEFAULT_TEXT_SIZE = 14,
        DEFAULT_TEXT_COLOR = Color3.new(1, 1, 1) -- White (colors applied via RichText)
    },
    -- NEW: Server Browser Config
    SERVER_BROWSER = {
        GAME_ID = 5208655184,
        UI_ELEMENTS = {
            StatusLabel = nil,
            ServerListFrame = nil,
            IsFetching = false,
            -- NEW: Info Panel Elements
            InfoGroup = nil,
            PlayerLabel = nil,
            PingLabel = nil,
            FPSLabel = nil,
            TeleportButton = nil,
            SelectedJobId = nil
        }
    }
}

-- Function to update PlayerESPHandler with current config
local function applyPlayerESPConfig()
    if ModuleInstances.playerEsp and ModuleInstances.playerEsp.setDisplayConfig then
        ModuleInstances.playerEsp:setDisplayConfig()
    end
end

-- ========================================
-- UI WINDOW AND TABS SETUP
-- ========================================

local function createMainWindow()
    return Library:CreateWindow({
        Title = '[Puppy Hub] ', -- Updated Title
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})
end

local function setupTabs(window)
    return {
        Visuals = window:AddTab('Visuals'),
        Combat = window:AddTab('Combat'),
        Movement = window:AddTab('Movement'),
        Misc = window:AddTab('Misc'),
        ServerBrowser = window:AddTab('Server Browser'), -- NEW: Server Browser Tab
        UISettings = window:AddTab('UI Settings'),
    }
end


-- Initialize Trigger Monitor
local triggerMonitor = TriggerMonitor and TriggerMonitor.new(connMgr) or nil

-- ========================================
-- SERVER BROWSER LOGIC (INTEGRATED)
-- ========================================

-- Renamed function to be more generic
local function sb_teleportToJob(jobId)
    if not jobId then 
        warn("Teleport failed: No JobId provided.")
        return 
    end
    
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    if sbui.StatusLabel then
        sbui.StatusLabel:SetText("Preparing to join...")
    end

    -- NEW: Use the ReplicatedStorage Event system instead of TeleportService or UI simulation
    local success, err = safeCall(function()
        local requests = ReplicatedStorage:FindFirstChild("Requests")
        local joinEvent = requests and requests:FindFirstChild("JoinPublicServer")
        
        if not joinEvent or not joinEvent:IsA("RemoteEvent") then
            warn("Cannot find 'JoinPublicServer' RemoteEvent in ReplicatedStorage.Requests")
            if sbui.StatusLabel then sbui.StatusLabel:SetText("Error: Join event not found!") end
            return
        end

        local serverInfo = ReplicatedStorage:FindFirstChild("ServerInfo")
        
        --[[
            OLD LOGIC (Removed):
            local jobFolder = serverInfo and serverInfo:FindFirstChild(jobId)
            local serverNameValue = jobFolder and jobFolder:FindFirstChild("ServerName")
            
            if serverNameValue and serverNameValue:IsA("StringValue") then
                -- Method 1: Found ServerName, use it
                local serverName = serverNameValue.Value
                warn("Found ServerName:", serverName, "for JobId:", jobId)
                if sbui.StatusLabel then sbui.StatusLabel:SetText("Joining server: " .. serverName) end
                joinEvent:FireServer(serverName)
            else
                -- Method 2: Could not find ServerName, use JobId as fallback
                warn("Could not find ServerName for JobId:", jobId, ". Firing with JobId directly.")
                if sbui.StatusLabel then sbui.StatusLabel:SetText("Joining server: " .. jobId) end
                joinEvent:FireServer(jobId)
            end
        ]]

        -- NEW LOGIC:
        -- Based on MenuServerClient.lua, the server *always* expects the JobId string,
        -- not the ServerName value.
        warn("Firing JoinPublicServer with JobId:", jobId)
        if sbui.StatusLabel then sbui.StatusLabel:SetText("Joining server: " .. jobId) end
        joinEvent:FireServer(jobId)

    end)
    
    if not success then
        warn("Error during JoinPublicServer event:", err)
        if sbui.StatusLabel then sbui.StatusLabel:SetText("Error: Join event failed.") end
    end
end

-- NEW: Function to display server info in the right panel
local function sb_displayServerInfo(server)
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    if not sbui.InfoGroup then return end

    -- Store the selected job ID
    sbui.SelectedJobId = server.id

    -- Update labels
    if sbui.PlayerLabel then
        sbui.PlayerLabel:SetText(string.format("Players: %d / %d", server.playing, server.maxPlayers))
    end
    if sbui.PingLabel then
        sbui.PingLabel:SetText(string.format("Ping: %d ms", server.ping))
    end
    if sbui.FPSLabel then
        sbui.FPSLabel:SetText(string.format("Server FPS: %.0f", server.fps))
    end
    
    -- Show the teleport button
    if sbui.TeleportButton then
        sbui.TeleportButton.Outer.Visible = true
    end
end

local function sb_clearServerList()
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    if not sbui.ServerListFrame then return end
    for _, child in ipairs(sbui.ServerListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- NEW: Clear info panel and hide teleport button
    if sbui.PlayerLabel then sbui.PlayerLabel:SetText("Select a server") end
    if sbui.PingLabel then sbui.PingLabel:SetText("Ping: N/A") end
    if sbui.FPSLabel then sbui.FPSLabel:SetText("Server FPS: N/A") end
    if sbui.TeleportButton then sbui.TeleportButton.Outer.Visible = false end
    sbui.SelectedJobId = nil
end

local function sb_populateUI(serverList)
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    if not sbui.ServerListFrame then return end
    
    -- Sort servers by player count (descending)
    table.sort(serverList, function(a, b)
        return a.playing > b.playing
    end)
    
    for _, server in ipairs(serverList) do
        local serverId = server.id
        local text = string.format(
            "Players: %d/%d | Ping: %dms | FPS: %.0f",
            server.playing,
            server.maxPlayers,
            server.ping,
            server.fps
        )
        
        -- Create a button for the server
        local button = Library:Create('TextButton', {
            Name = serverId,
            Text = text,
            Size = UDim2.new(1, -10, 0, 30),
            ZIndex = 10, -- ZINDEX FIX
            -- Parent = sbui.ServerListFrame, -- Removed from properties
            BackgroundColor3 = Library.MainColor,
            BorderColor3 = Library.OutlineColor,
            BorderMode = Enum.BorderMode.Inset,
            TextColor3 = Library.FontColor,
            TextSize = 14,
            Font = Library.Font,
        })
        
        -- Add hover effect
        Library:OnHighlight(button, button,
            { BorderColor3 = 'AccentColor' },
            { BorderColor3 = 'OutlineColor' }
        )
        
        -- Add click event
        button.MouseButton1Click:Connect(function()
            -- NEW: Display info instead of teleporting
            sb_displayServerInfo(server)
        end)
        
        -- Set Parent *after* all properties are set
        button.Parent = sbui.ServerListFrame
    end
    
    -- Update canvas size
    -- task.wait() -- This is unreliable
    -- A better way to wait for layout update:
    task.delay(0.1, function()
        local layout = sbui.ServerListFrame:FindFirstChildOfClass("UIListLayout")
        if layout then
            sbui.ServerListFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y)
        end
    end)
end

local function sb_fetchServers()
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    if sbui.IsFetching then return end
    sbui.IsFetching = true
    
    if sbui.StatusLabel then
        sbui.StatusLabel:SetText("Fetching servers...")
    end
    
    -- Clear previous list
    sb_clearServerList()
    
    -- Run in a new thread to not yield the game
    task.spawn(function()
        local success, response = safeCall(function()
            -- NEW: Use HttpGet as a fallback if request() is not available
            local httpFetch
            if typeof(request) == "function" then
                httpFetch = function(url)
                    local res = request({ Url = url, Method = "GET", Headers = { ["Accept"] = "application/json" } })
                    if res and res.Success then
                        return res.Body
                    else
                        warn("request() failed:", res.StatusCode, res.StatusMessage)
                        return nil
                    end
                end
            elseif typeof(game.HttpGet) == "function" then
                warn("`request` not found. Falling back to HttpGet for Server Browser.")
                httpFetch = function(url)
                    return game:HttpGet(url)
                end
            else
                warn("No HTTP function (request or HttpGet) is available. Cannot fetch servers.")
                return nil
            end

            -- Use a proxy to bypass Roblox's request limitations
            local url = string.format(
                "https://roproxy-production-0200.up.railway.app/games/v1/games/%d/servers/0?sortOrder=2&excludeFullGames=false&limit=100",
                CONFIG.SERVER_BROWSER.GAME_ID
            )
            
            return httpFetch(url)
        end)
        
        sbui.IsFetching = false
        
        if not success or not response then
            if sbui.StatusLabel then sbui.StatusLabel:SetText("Error: Failed to fetch. Check console.") end
            warn("ServerBrowser fetch error:", response)
            return
        end
        
        local decodeSuccess, serverData = safeCall(HttpService.JSONDecode, HttpService, response)
        
        if not decodeSuccess or not serverData or not serverData.data then
            if sbui.StatusLabel then sbui.StatusLabel:SetText("Error: Failed to parse server data.") end
            warn("ServerBrowser JSON decode error:", serverData)
            return
        end
        
        sb_populateUI(serverData.data)
        
        if #serverData.data == 0 then
            if sbui.StatusLabel then sbui.StatusLabel:SetText("No servers found.") end
        else
            if sbui.StatusLabel then sbui.StatusLabel:SetText(string.format("Loaded %d servers.", #serverData.data)) end
        end
    end)
end


-- ========================================
-- UI CALLBACK HANDLERS
-- ========================================

local UICallbacks = {}

-- Player ESP callbacks
function UICallbacks.onTogglePlayerESP(enabled)
    features.PlayerEsp = enabled -- Update global state
    if ModuleInstances.playerEsp then
        if enabled then
            ModuleInstances.playerEsp:enable()
            print("[Player ESP] Enabled")
        else
            ModuleInstances.playerEsp:disable()
            print("[Player ESP] Disabled")
        end
    end
end

function UICallbacks.onPlayerESPTextSizeChanged(value)
    if ModuleInstances.playerEsp then ModuleInstances.playerEsp:setTextSize(value) end
end

function UICallbacks.onPlayerESPTextColorChanged(value)
     if ModuleInstances.playerEsp then ModuleInstances.playerEsp:setTextColor(value) end
end

-- Auto-Aim callbacks
function UICallbacks.onToggleAutoAim(enabled)
    if ModuleInstances.autoAim then
        if enabled then
            ModuleInstances.autoAim:enable()
            print("[Auto-Aim] Enabled")
        else
            ModuleInstances.autoAim:disable()
            print("[Auto-Aim] Disabled")
        end
    end
end

function UICallbacks.onAutoAimFOVChanged(value)
    if ModuleInstances.autoAim then ModuleInstances.autoAim:setFOV(value) end
end

function UICallbacks.onAutoAimToolsChanged(selectedTools)
     if ModuleInstances.autoAim then ModuleInstances.autoAim:setTools(selectedTools) end
end

function UICallbacks.onStudsBehindMinChanged(value)
    CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.min = value
    if ModuleInstances.autoAim then
        ModuleInstances.autoAim:setStudsBehindRange(
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.min, 
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.max
        )
    end
end

function UICallbacks.onStudsBehindMaxChanged(value)
    CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.max = value
     if ModuleInstances.autoAim then
        ModuleInstances.autoAim:setStudsBehindRange(
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.min, 
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.max
        )
    end
end

-- Better Leaderboard callbacks
function UICallbacks.onToggleBetterLeaderboard(enabled)
    if ModuleInstances.betterLeaderboard then
        if enabled then
            ModuleInstances.betterLeaderboard:enable()
            print("[Better Leaderboard] Enabled")
        else
            ModuleInstances.betterLeaderboard:disable()
            print("[Better Leaderboard] Disabled")
        end
    end
end

-- Trinket ESP callbacks
function UICallbacks.onToggleTrinketESP(enabled)
    features.TrinketEsp = enabled -- Update global state
     if ModuleInstances.trinketEsp then
        if enabled then
            ModuleInstances.trinketEsp:enable()
            print("[Trinket ESP] Enabled")
        else
            ModuleInstances.trinketEsp:disable()
            print("[Trinket ESP] Disabled")
        end
    end
end

-- Mob ESP callback
function UICallbacks.onToggleMobESP(enabled)
    features.MobEsp = enabled -- Update global state
    if ModuleInstances.mobEsp then
        if enabled then
            ModuleInstances.mobEsp:enable()
            print("[Mob ESP] Enabled")
        else
            ModuleInstances.mobEsp:disable()
            print("[Mob ESP] Disabled")
        end
    end
end

-- Callback for ClearTrinketESPButton
function UICallbacks.onClearTrinketESP()
    if ModuleInstances.trinketEsp and ModuleInstances.trinketEsp.clearAllBillboards then
        ModuleInstances.trinketEsp:clearAllBillboards()
        print("[Trinket ESP] Cleared all billboards.")
    end
end

-- Callback for UnloadButton
function UICallbacks.onUnloadScript()
    Library:Unload()
end


-- Intent Billboard toggle
function UICallbacks.onToggleIntentBillboard(enabled)
    if Intent then
        if enabled then
            Intent.enable()
        else
            Intent.disable()
        end
    end
end

-- AutoBlock callbacks
function UICallbacks.onToggleAutoBlock(enabled)
    if ModuleInstances.autoBlock then
        if enabled then
            ModuleInstances.autoBlock:enable()
            print("[AutoBlock] Enabled")
        else
            ModuleInstances.autoBlock:disable()
            print("[AutoBlock] Disabled")
        end
    end
end


-- Observe UI Callback
function UICallbacks.onToggleObserveUI(enabled)
    features.ShowObserveGui = enabled -- Update global state
    if ModuleInstances.observeUI then
        if enabled then ModuleInstances.observeUI:enable() else ModuleInstances.observeUI:disable() end
    end
end

-- Chat Log Callback
function UICallbacks.onToggleChatLogUI(enabled)
    features.ShowChatLogGui = enabled -- Update global state
     if ModuleInstances.chatLog then
        if enabled then ModuleInstances.chatLog:enable() else ModuleInstances.chatLog:disable() end
    end
end

-- Spell Percentage Callback
function UICallbacks.onToggleSpellPercentage(enabled)
    features.ShowSpellPercentages = enabled -- Update global state
     if ModuleInstances.spellPercentage then
        if enabled then ModuleInstances.spellPercentage:enable() else ModuleInstances.spellPercentage:disable() end
    end
end

-- NEW: Cooldown Indicator Callback
function UICallbacks.onToggleCooldownIndicator(enabled)
    features.ShowCooldowns = enabled -- Update global state
     if ModuleInstances.cooldownIndicator then
        if enabled then ModuleInstances.cooldownIndicator:enable() else ModuleInstances.cooldownIndicator:disable() end
    end
end

-- Walkspeed Callbacks
local walkspeedConnection = nil
function UICallbacks.onToggleWalkspeedOverride(enabled)
    features.WalkspeedOverride = enabled -- Update global state
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if enabled then
        if humanoid then
            -- Connect if not already connected
            if not walkspeedConnection then
                 walkspeedConnection = humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
                    if features.WalkspeedOverride and humanoid then -- Double check flag and humanoid
                        -- Use pcall for safety in case humanoid becomes invalid
                        pcall(function() humanoid.WalkSpeed = features.Walkspeed end) 
                    end
                 end)
                 connMgr:add(walkspeedConnection) -- Manage connection
            end
        end
        print("[Walkspeed] Override Enabled: " .. features.Walkspeed)
    else
        -- Disconnect
        if walkspeedConnection then
            walkspeedConnection:Disconnect()
            walkspeedConnection = nil
        end
        -- Use pcall for safety
        if humanoid then pcall(function() humanoid.WalkSpeed = 16 end) end -- Reset to default
        print("[Walkspeed] Override Disabled")
    end
end


function UICallbacks.onWalkspeedChanged(value)
    features.Walkspeed = value -- Update global state
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if features.WalkspeedOverride and humanoid then
        -- Use pcall for safety
       pcall(function() humanoid.WalkSpeed = value end) -- Update speed immediately if override is on
    end
end


-- NEW: Simple NoFog Callback
function UICallbacks.onToggleNoFog(enabled)
    features.NoFog = enabled
    if ModuleInstances.noFog then
        if enabled then
            ModuleInstances.noFog:enable()
        else
            ModuleInstances.noFog:disable()
        end
    end
end


-- TransTrail Callback
function UICallbacks.onToggleTransTrail(enabled)
    features.TransTrail = enabled -- Update global state
     if ModuleInstances.transTrail then
        if enabled then ModuleInstances.transTrail:enable() else ModuleInstances.transTrail:disable() end
    end
end

-- Combo Counter Callback
function UICallbacks.onToggleComboCounter(enabled)
    features.ShowComboCounter = enabled -- Update global state
     if ModuleInstances.comboCounter then
        if enabled then ModuleInstances.comboCounter:enable() else ModuleInstances.comboCounter:disable() end
    end
end

-- NEW: Auto Demon Step Callback
function UICallbacks.onToggleAutoDemonStep(enabled)
    features.AutoDemonStep = enabled -- Update global state
    if ModuleInstances.autoDemonStep then
        if enabled then ModuleInstances.autoDemonStep:enable() else ModuleInstances.autoDemonStep:disable() end
    end
end

-- ========================================
-- UI COMPONENT CREATION
-- ========================================

-- New function to create components based on PuppyAdmin structure
local function createPuppyHubTabs(tabs, fovManager)

    -- Visuals Tab
    local playerESPGroup = tabs.Visuals:AddLeftGroupbox('Player ESP')
    local trinketESPGroup = tabs.Visuals:AddRightGroupbox('Item/Mob ESP') -- Renamed group
    local otherVisualsGroup = tabs.Visuals:AddLeftGroupbox('Other Visuals')

    local playerESPToggle = playerESPGroup:AddToggle('PlayerESP', {
        Text = 'Enable Player ESP', Default = features.PlayerEsp, Tooltip = 'Display player information',
        Callback = UICallbacks.onTogglePlayerESP
    })
    -- Automatically add toggles for Player ESP components
    if ModuleInstances.playerEsp and ModuleInstances.playerEsp.displayConfig then
        for configKey, defaultValue in pairs(ModuleInstances.playerEsp.displayConfig) do
            local labelText = configKey:gsub("show", ""):gsub("^%l", string.upper):gsub("PlayerName", "Name"):gsub("HeldItem", "Held Item") -- Better labels
            local toggleName = configKey:gsub("show", "Show") .. "ESP" -- Add suffix to avoid conflicts
            
            playerESPGroup:AddToggle(toggleName, {
                Text = "Show " .. labelText, Default = defaultValue,
                Callback = function(val)
                    if ModuleInstances.playerEsp then
                        ModuleInstances.playerEsp.displayConfig[configKey] = val
                        applyPlayerESPConfig()
                    end
                end
            })
        end
    end
     playerESPGroup:AddSlider('PlayerESPTextSize', {
        Text = 'Text Size', Default = CONFIG.PLAYER_ESP.DEFAULT_TEXT_SIZE, Min = 7, Max = 40, Rounding = 0,
        Callback = UICallbacks.onPlayerESPTextSizeChanged
    })

    trinketESPGroup:AddToggle('TrinketESP', {
        Text = 'Enable Trinket ESP', Default = features.TrinketEsp, Tooltip = 'Show names for trinkets',
        Callback = UICallbacks.onToggleTrinketESP
    })
    
    trinketESPGroup:AddButton('Clear All Trinkets', UICallbacks.onClearTrinketESP)
    
    trinketESPGroup:AddToggle('MobESP', {
        Text = 'Enable Mob ESP', Default = features.MobEsp, Tooltip = 'Show names and health for mobs',
        Callback = UICallbacks.onToggleMobESP
    })


    otherVisualsGroup:AddToggle('IntentBillboard', {
        Text = 'Intent Billboard', Default = false, Tooltip = 'Show equipped tool above players',
        Callback = UICallbacks.onToggleIntentBillboard
    })
     otherVisualsGroup:AddToggle('TransTrailToggle', {
        Text = 'Trans Flag Trail', Default = features.TransTrail, Tooltip = 'Adds a trans flag trail effect',
        Callback = UICallbacks.onToggleTransTrail
    })
    otherVisualsGroup:AddToggle('NoFogToggle', {
        Text = 'Enable NoFog', Default = features.NoFog, Tooltip = 'Removes fog completely',
        Callback = UICallbacks.onToggleNoFog
    })


    -- Combat Tab
    local autoAimGroup = tabs.Combat:AddLeftGroupbox('AutoAim')
    local autoBlockGroup = tabs.Combat:AddRightGroupbox('Auto Block')
    local combatVisualsGroup = tabs.Combat:AddLeftGroupbox('Combat Visuals')

     autoAimGroup:AddToggle('AutoAimToggle', {
        Text = 'Enable Auto-Aim', Default = false, Tooltip = 'Enable or disable Auto-Aim',
        Callback = UICallbacks.onToggleAutoAim
    })
    autoAimGroup:AddSlider('AutoAimFOV', {
        Text = 'FOV (degrees)', Default = CONFIG.AUTO_AIM.DEFAULT_FOV, Min = 5, Max = 90, Rounding = 0, Tooltip = 'Field of view for auto-aim',
        Callback = UICallbacks.onAutoAimFOVChanged
    })
    autoAimGroup:AddLabel('FOV Circle Color'):AddColorPicker('FOVCircleColor', {
        Default = CONFIG.FOV_CIRCLE.DEFAULT_COLOR, Title = 'FOV Circle Color',
        Callback = function(color) if fovManager then fovManager:setColor(color) end end
    })
    autoAimGroup:AddToggle('ShowFOVCircle', {
        Text = 'Show FOV Circle', Default = false, Tooltip = 'Display the auto-aim FOV circle',
        Callback = function(visible) if fovManager then fovManager:setVisible(visible) end end
    })
    autoAimGroup:AddSlider('StudsBehindMin', {
        Text = 'Studs Behind Min', Default = CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.min, Min = 5, Max = 50, Rounding = 0,
        Callback = UICallbacks.onStudsBehindMinChanged
    })
    autoAimGroup:AddSlider('StudsBehindMax', {
        Text = 'Studs Behind Max', Default = CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.max, Min = 5, Max = 50, Rounding = 0,
        Callback = UICallbacks.onStudsBehindMaxChanged
    })
    -- Auto Aim Tools Dropdown
    local function getAvailableToolsFromBackpack() return CONFIG.AUTO_AIM.AVAILABLE_TOOLS end -- Placeholder
    local function extractToolNamesFromDisplay(displayNames)
        local cleanNames = {}
        for _, displayName in ipairs(displayNames) do
            local toolName = displayName:gsub(" %[Equipped%]$", ""):gsub(" %[Backpack%]$", "")
            table.insert(cleanNames, toolName)
        end
        return cleanNames
    end
    local availableTools = getAvailableToolsFromBackpack()
    autoAimGroup:AddDropdown('AutoAimTools', {
        Values = availableTools, Default = {}, Multi = true, Text = 'Auto-Aim Tools', Tooltip = 'Select tools for auto-aim',
        Callback = function(selected)
            local cleanSelected = extractToolNamesFromDisplay(selected)
            UICallbacks.onAutoAimToolsChanged(cleanSelected)
        end
    })


    autoBlockGroup:AddToggle('AutoBlockToggle', {
        Text = 'Enable Auto Block', Default = false, Tooltip = 'Automatically block specific attacks',
        Callback = UICallbacks.onToggleAutoBlock
    })
    -- Auto Block Threat Selection (Skills/Attack Types)
    if ModuleInstances.autoBlock then
        local allThreats = ModuleInstances.autoBlock:getAllThreats()
        local skillOptions, attackTypeOptions = {}, {}
        local threatIdByName = {}
        for threatId, config in pairs(allThreats) do
            threatIdByName[config.name] = threatId
            if config.category == "skills" then table.insert(skillOptions, config.name) end
            if config.category == "attack_type" then table.insert(attackTypeOptions, config.name) end
        end
        
        autoBlockGroup:AddDropdown('BlockSkillsDropdown', {
            Values = skillOptions, Default = skillOptions, Multi = true, Text = 'Skills to Block', Tooltip = 'Select skills to auto-block',
            Callback = function(selected)
                for _, name in ipairs(skillOptions) do
                    local threatId = threatIdByName[name]
                    if ModuleInstances.autoBlock then
                       if selected[name] then ModuleInstances.autoBlock:addThreat(threatId, allThreats[threatId])
                       else ModuleInstances.autoBlock:removeThreat(threatId) end
                    end
                end
            end
        })
        autoBlockGroup:AddDropdown('BlockAttackTypesDropdown', {
            Values = attackTypeOptions, Default = attackTypeOptions, Multi = true, Text = 'Attack Types to Block', Tooltip = 'Select attack types to auto-block',
            Callback = function(selected)
                 for _, name in ipairs(attackTypeOptions) do
                    local threatId = threatIdByName[name]
                     if ModuleInstances.autoBlock then
                       if selected[name] then ModuleInstances.autoBlock:addThreat(threatId, allThreats[threatId])
                       else ModuleInstances.autoBlock:removeThreat(threatId) end
                    end
                end
            end
        })
    end

    combatVisualsGroup:AddToggle('SpellPercentageToggle', {
        Text = 'Spell % Overlay', Default = features.ShowSpellPercentages, Tooltip = 'Show mana cost overlay for spells',
        Callback = UICallbacks.onToggleSpellPercentage
    })
    combatVisualsGroup:AddToggle('ComboCounterToggle', {
        Text = 'M1 Combo Counter', Default = features.ShowComboCounter, Tooltip = 'Show M1 combo count',
        Callback = UICallbacks.onToggleComboCounter
    })
    combatVisualsGroup:AddToggle('EnableDamageRegenIndicators', {
        Text = 'Damage/Regen Indicators', Default = false, Tooltip = 'Show floating damage/healing numbers',
        Callback = function(val) if ModuleInstances.indicator then if val then ModuleInstances.indicator:enable() else ModuleInstances.indicator:disable() end end end
    })
    combatVisualsGroup:AddToggle('CooldownIndicatorToggle', {
        Text = 'Show Cooldowns', Default = features.ShowCooldowns, Tooltip = 'Show ability cooldowns on hotbar',
        Callback = UICallbacks.onToggleCooldownIndicator
    })


    -- Movement Tab
    local movementGroup = tabs.Movement:AddLeftGroupbox('Speed & Movement')
    movementGroup:AddToggle('WalkspeedOverrideToggle', {
        Text = 'Override Walkspeed', Default = features.WalkspeedOverride, Tooltip = 'Enable custom walkspeed',
        Callback = UICallbacks.onToggleWalkspeedOverride
    })
    movementGroup:AddSlider('WalkspeedSlider', {
        Text = 'Walkspeed Value', Default = features.Walkspeed, Min = 16, Max = 100, Rounding = 0,
        Callback = UICallbacks.onWalkspeedChanged
    })
    -- NEW: Add Auto Demon Step toggle
    movementGroup:AddToggle('AutoDemonStepToggle', {
        Text = 'Auto Demon Step', Default = features.AutoDemonStep, Tooltip = 'Hold LeftAlt to auto-use Demon Step. Hold W/S to charge mana.',
        Callback = UICallbacks.onToggleAutoDemonStep
    })

    -- Misc Tab
    local miscGroup = tabs.Misc:AddLeftGroupbox('Miscellaneous')
    local triggersGroup = tabs.Misc:AddRightGroupbox('Triggers') -- Move triggers here
    local observeGroup = tabs.Misc:AddLeftGroupbox('Observe & Chat') -- Group Observe/Chat
    local connectionsGroup = tabs.Misc:AddRightGroupbox('System Info') -- Move connections here
    local potionGroup = tabs.Misc:AddLeftGroupbox('Auto Potion') -- NEW: Potion Group

    miscGroup:AddToggle('BetterLeaderboard', {
        Text = 'Better Leaderboard', Default = false, Tooltip = 'Use enhanced leaderboard',
        Callback = UICallbacks.onToggleBetterLeaderboard
    })

    if triggerMonitor then
        local triggersLabel = triggersGroup:AddLabel(triggerMonitor:getTriggersLabelText(), true)
        triggerMonitor:setLabel(triggersLabel)
        triggerMonitor:connectTriggerListeners()
        triggersGroup:AddToggle('EnableTriggerMonitor', {
            Text = 'Enable Trigger Monitor', Default = true, Tooltip = 'Monitor spawn triggers (affects performance)',
            Callback = function(enabled) triggerMonitor:setEnabled(enabled) end
        })
        triggerMonitor:setEnabled(true) -- Start enabled
    else
        triggersGroup:AddLabel("Trigger Monitor N/A", true)
    end

    observeGroup:AddToggle('ObserveUIToggle', {
        Text = 'Show Observe UI', Default = features.ShowObserveGui, Tooltip = 'Toggle the player observation UI',
        Callback = UICallbacks.onToggleObserveUI
    })
    observeGroup:AddToggle('ChatLogUIToggle', {
        Text = 'Show Chat Log UI', Default = features.ShowChatLogGui, Tooltip = 'Toggle the chat log UI',
        Callback = UICallbacks.onToggleChatLogUI
    })

    -- NEW: Auto Potion Group
    if ModuleInstances.autoPotion then
        potionGroup:AddDropdown('AutoPotionSelect', {
            -- Title = "Select Potion", -- 'Title' is not a valid prop for Dropdown, 'Text' is, but it's compact
            Values = ModuleInstances.autoPotion.potionnames,
            Default = ModuleInstances.autoPotion.selectedPotion,
            Multi = false,
            Callback = function(val)
                if ModuleInstances.autoPotion then
                    ModuleInstances.autoPotion:setSelectedPotion(val)
                end
            end
        })

        potionGroup:AddInput('AutoPotionAmount', {
            Text = "Amount to craft",
            Placeholder = "1",
            Default = "1",
            Numeric = true,
            Finished = true, -- Updates when user presses Enter
            Callback = function(val)
                if ModuleInstances.autoPotion then
                    ModuleInstances.autoPotion:setCraftAmount(val)
                end
            end
        })
        
        local brewButton = potionGroup:AddButton("Start / Stop Crafting", function()
            if ModuleInstances.autoPotion then
                -- The toggle function already spawns a new thread
                ModuleInstances.autoPotion:toggleCrafting()
            end
        end)
        
        -- Add the tooltip separately to the returned button object
        brewButton:AddTooltip("Must be near an Alchemy Station. Click to start, click again to stop.")
    else
        potionGroup:AddLabel("Auto Potion module failed to load.")
    end

    -- Connections Info group
    local espLabel = connectionsGroup:AddLabel('PlayerESP: ...')
    local trinketLabel = connectionsGroup:AddLabel('TrinketESP: ...')
    local mobLabel = connectionsGroup:AddLabel('MobESP: ...') 
    local cooldownLabel = connectionsGroup:AddLabel('Cooldowns: ...') -- NEW
    local leaderboardLabel = connectionsGroup:AddLabel('BetterLeaderboard: ...')
    local nofogLabel = connectionsGroup:AddLabel('NoFog: ...') -- NEW
    local intentLabel = connectionsGroup:AddLabel('Intent: ...')
    local observeLabel = connectionsGroup:AddLabel('ObserveUI: ...')
    local chatLogLabel = connectionsGroup:AddLabel('ChatLog: ...')
    local spellPercLabel = connectionsGroup:AddLabel('Spell%: ...')
    local transTrailLabel = connectionsGroup:AddLabel('TransTrail: ...')
    local comboCountLabel = connectionsGroup:AddLabel('ComboCount: ...')
    local scriptLabel = connectionsGroup:AddLabel('Script: ...')
    
    -- Performance Monitor
    local performanceLabel = connectionsGroup:AddLabel('Performance: ...')
    if PerformanceMonitor then
        local perfMonitor = PerformanceMonitor.new()
        perfMonitor:setLabel(performanceLabel)
        perfMonitor:start() -- Start by default
        connectionsGroup:AddToggle('EnablePerformanceMonitor', {
            Text = 'Performance Monitor', Default = true, Tooltip = 'Monitor FPS and performance metrics',
            Callback = function(enabled) if enabled then perfMonitor:start() else perfMonitor:stop() end end
        })
    end
    
    -- Function to update connection counts (throttled)
    local lastConnectionUpdate = 0
    local connectionUpdateInterval = 2 
    local function updateConnectionsLabel()
        local now = tick()
        if now - lastConnectionUpdate < connectionUpdateInterval then return end
        lastConnectionUpdate = now
        
        -- Helper function to safely get connection count string
        local function getConnCountStr(instance, path)
            local target = instance
            if path then 
                for _, key in ipairs(path) do
                    if target then target = target[key] else return "0" end
                end
            end
            
            if not target then return "N/A" end
            
            if target.count and type(target.count) == "function" then return tostring(target:count())
            elseif type(target) == "table" and rawget(target, "_connections") then
                -- Count keys in a table
                local count = 0
                for _ in pairs(target._connections) do count = count + 1 end
                return tostring(count)
            elseif type(target) == "table" and rawget(target, "_connMgr") and target._connMgr.count then return tostring(target._connMgr:count()) -- For modules using ConnectionManager directly
            elseif type(target) == "table" and rawget(target, "_connectionManager") and target._connectionManager.count then return tostring(target._connectionManager:count()) -- For trinket_esp_handler
            elseif target.loopConnection then return "1" -- Specific for new NoFog
            elseif target.heartbeatConn then return "1" -- Specific for new AutoDemonStep
            else return "0" end
        end
        
        if espLabel then espLabel:SetText('PlayerESP: ' .. getConnCountStr(ModuleInstances.playerEsp, {"_connMgr"})) end
        if trinketLabel then trinketLabel:SetText('TrinketESP: ' .. getConnCountStr(ModuleInstances.trinketEsp, {"_connectionManager"})) end
        if mobLabel then mobLabel:SetText('MobESP: ' .. getConnCountStr(ModuleInstances.mobEsp, {"_connMgr"})) end 
        if cooldownLabel then cooldownLabel:SetText('Cooldowns: ' .. getConnCountStr(ModuleInstances.cooldownIndicator, {"_connections"})) end -- NEW
        if leaderboardLabel then leaderboardLabel:SetText('BetterLB: ' .. getConnCountStr(ModuleInstances.betterLeaderboard, {"_connMgr"})) end
        if nofogLabel then nofogLabel:SetText('NoFog: ' .. getConnCountStr(ModuleInstances.noFog)) end -- NEW
        if intentLabel then intentLabel:SetText('Intent: ' .. getConnCountStr(Intent, {"connectionMgr"})) end -- Intent module structure
        if observeLabel then observeLabel:SetText('ObserveUI: ' .. getConnCountStr(ModuleInstances.observeUI)) end 
        if chatLogLabel then chatLogLabel:SetText('ChatLog: ' .. getConnCountStr(ModuleInstances.chatLog)) end 
        if spellPercLabel then spellPercLabel:SetText('Spell%: ' .. getConnCountStr(ModuleInstances.spellPercentage)) end 
        if transTrailLabel then transTrailLabel:SetText('TransTrail: ' .. getConnCountStr(ModuleInstances.transTrail)) end 
        if comboCountLabel then comboCountLabel:SetText('ComboCount: ' .. getConnCountStr(ModuleInstances.comboCounter)) end 
        if scriptLabel then scriptLabel:SetText('Script: ' .. getConnCountStr(connMgr)) end
    end

    
    -- Update connections label loop (only when UI visible)
    local isUIVisible = true -- Assume visible initially
    connMgr:add(RunService.Heartbeat:Connect(function()
        if isUIVisible then updateConnectionsLabel() end
    end))
    -- Listen for menu toggle to update isUIVisible
    local function checkToggleKey(input)
         if type(Library.ToggleKeybind) == 'table' then -- KeyPicker
            if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode.Name == Library.ToggleKeybind.Value then
                isUIVisible = not isUIVisible
            end
        elseif Library.ToggleKeybind then -- Enum
             if input.KeyCode == Library.ToggleKeybind then
                isUIVisible = not isUIVisible
            end
        else -- Default (Assuming Insert)
             if input.KeyCode == Enum.KeyCode.Insert then 
                isUIVisible = not isUIVisible
            end
        end
    end
    connMgr:add(UserInputService.InputBegan:Connect(checkToggleKey))
    
    -- ===================================
    -- NEW: Server Browser Tab Setup
    -- ===================================
    local sbui = CONFIG.SERVER_BROWSER.UI_ELEMENTS
    
    -- Left Group: Server List
    local sbGroup = tabs.ServerBrowser:AddLeftGroupbox('Server List')
    
    sbGroup:AddButton('Refresh', sb_fetchServers)
    
    -- Store UI elements in the config
    sbui.StatusLabel = sbGroup:AddLabel("Click 'Refresh' to load servers.")
    
    -- Add a small blank space
    sbGroup:AddBlank(5)
    
    local scrollingFrame = Library:Create('ScrollingFrame', {
        Name = "ServerListScroll",
        Size = UDim2.new(1, -4, 0, 400), -- FIXED: Use fixed height and account for padding
        ZIndex = 6, -- ZINDEX FIX
        Parent = sbGroup.Container,
        BackgroundColor3 = Library.BackgroundColor,
        BorderColor3 = Library.OutlineColor,
        BorderMode = Enum.BorderMode.Inset,
        ScrollBarThickness = 6,
        ScrollBarImageColor3 = Library.AccentColor,
    })
    
    Library:Create('UIListLayout', {
        Padding = UDim.new(0, 5),
        FillDirection = Enum.FillDirection.Vertical,
        SortOrder = Enum.SortOrder.LayoutOrder,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Parent = scrollingFrame,
    })
    
    sbui.ServerListFrame = scrollingFrame

    -- Right Group: Server Info
    local infoGroup = tabs.ServerBrowser:AddRightGroupbox('Server Info')
    sbui.InfoGroup = infoGroup -- Store reference to groupbox
    
    sbui.PlayerLabel = infoGroup:AddLabel("Select a server")
    sbui.PingLabel = infoGroup:AddLabel("Ping: N/A") -- FIXED: Was infoInfo
    sbui.FPSLabel = infoGroup:AddLabel("Server FPS: N/A")
    
    infoGroup:AddBlank(10) -- Add spacing
    
    sbui.TeleportButton = infoGroup:AddButton('Teleport to Server', function()
        sb_teleportToJob(sbui.SelectedJobId)
    end)
    
    -- Hide teleport button initially
    sbui.TeleportButton.Outer.Visible = false


    -- Apply initial default states from 'features' table to UI
    local allToggles = Library.GetObjects and Library:GetObjects("Toggle") or Toggles -- Compatibility
    if allToggles then
        if allToggles.PlayerESP then pcall(allToggles.PlayerESP.SetValue, allToggles.PlayerESP, features.PlayerEsp) end
        if allToggles.TrinketESP then pcall(allToggles.TrinketESP.SetValue, allToggles.TrinketESP, features.TrinketEsp) end
        if allToggles.MobESP then pcall(allToggles.MobESP.SetValue, allToggles.MobESP, features.MobEsp) end 
        if allToggles.ObserveUIToggle then pcall(allToggles.ObserveUIToggle.SetValue, allToggles.ObserveUIToggle, features.ShowObserveGui) end
        if allToggles.ChatLogUIToggle then pcall(allToggles.ChatLogUIToggle.SetValue, allToggles.ChatLogUIToggle, features.ShowChatLogGui) end
        if allToggles.SpellPercentageToggle then pcall(allToggles.SpellPercentageToggle.SetValue, allToggles.SpellPercentageToggle, features.ShowSpellPercentages) end
        if allToggles.CooldownIndicatorToggle then pcall(allToggles.CooldownIndicatorToggle.SetValue, allToggles.CooldownIndicatorToggle, features.ShowCooldowns) end -- NEW
        if allToggles.TransTrailToggle then pcall(allToggles.TransTrailToggle.SetValue, allToggles.TransTrailToggle, features.TransTrail) end
        if allToggles.ComboCounterToggle then pcall(allToggles.ComboCounterToggle.SetValue, allToggles.ComboCounterToggle, features.ShowComboCounter) end
        
        -- NEW: Set new toggles
        if allToggles.NoFogToggle then pcall(allToggles.NoFogToggle.SetValue, allToggles.NoFogToggle, features.NoFog) end
        if allToggles.AutoDemonStepToggle then pcall(allToggles.AutoDemonStepToggle.SetValue, allToggles.AutoDemonStepToggle, features.AutoDemonStep) end -- NEW
        
        if allToggles.WalkspeedOverrideToggle then pcall(allToggles.WalkspeedOverrideToggle.SetValue, allToggles.WalkspeedOverrideToggle, features.WalkspeedOverride) end
    end
    -- Apply initial slider values
    local allSliders = Library.GetObjects and Library:GetObjects("Slider") or Options -- Compatibility
     if allSliders then
        if allSliders.WalkspeedSlider then pcall(allSliders.WalkspeedSlider.SetValue, allSliders.WalkspeedSlider, features.Walkspeed) end
    end

    -- Initialize Auto-Aim defaults (if module exists)
    if ModuleInstances.autoAim then
        ModuleInstances.autoAim:setRange(CONFIG.AUTO_AIM.DEFAULT_RANGE)
        ModuleInstances.autoAim:setTimeToHit(CONFIG.AUTO_AIM.DEFAULT_TIME_TO_HIT)
        ModuleInstances.autoAim:setStudsBehindRange(
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.min,
            CONFIG.AUTO_AIM.DEFAULT_STUDS_BEHIND.max
        )
    end

    -- Initial setup for FOV Circle color and visibility (if manager exists)
    if fovManager then
        fovManager:setColor(CONFIG.FOV_CIRCLE.DEFAULT_COLOR)
        -- Set initial visibility based on UI toggle's default state (if ShowFOVCircle toggle exists)
        local fovToggle = allToggles and allToggles.ShowFOVCircle
        if fovToggle then fovManager:setVisible(fovToggle.Value) end
    end
end


local function createUISettingsTab(uiSettingsTab)
    local menuGroup = uiSettingsTab:AddLeftGroupbox('Menu')
    
    menuGroup:AddButton('Unload', UICallbacks.onUnloadScript)
    
    menuGroup:AddLabel('Menu bind'):AddKeyPicker('MenuKeybind', { 
        Default = 'Insert', -- Changed Default keybind
        NoUI = true, 
        Text = 'Menu keybind' 
    })
    
    -- Set the toggle keybind for the menu
    Library.ToggleKeybind = Options.MenuKeybind
end

-- Define Puppy Theme Colors
local puppyThemeColors = {
    FontColor = Color3.fromRGB(255, 255, 255),       -- White
    MainColor = Color3.fromRGB(255, 182, 193),       -- Light Pink
    BackgroundColor = Color3.fromRGB(255, 204, 213), -- Lighter Pink
    AccentColor = Color3.fromRGB(255, 105, 180),     -- Hot Pink
    OutlineColor = Color3.fromRGB(221, 160, 221),    -- Plum/Darker Pink
    RiskColor = Color3.fromRGB(255, 69, 0)           -- OrangeRed for risky options
}

local function applyPuppyTheme()
     Library.FontColor = puppyThemeColors.FontColor
     Library.MainColor = puppyThemeColors.MainColor
     Library.BackgroundColor = puppyThemeColors.BackgroundColor
     Library.AccentColor = puppyThemeColors.AccentColor
     Library.OutlineColor = puppyThemeColors.OutlineColor
     Library.RiskColor = puppyThemeColors.RiskColor
     
     -- Recalculate dark accent color
     Library.AccentColorDark = Library:GetDarkerColor(Library.AccentColor)
     
     -- Update UI elements immediately
     Library:UpdateColorsUsingRegistry()
     
     -- Update theme manager options if they exist
     if Options.FontColor then pcall(Options.FontColor.SetValueRGB, Options.FontColor, Library.FontColor) end
     if Options.MainColor then pcall(Options.MainColor.SetValueRGB, Options.MainColor, Library.MainColor) end
     if Options.BackgroundColor then pcall(Options.BackgroundColor.SetValueRGB, Options.BackgroundColor, Library.BackgroundColor) end
     if Options.AccentColor then pcall(Options.AccentColor.SetValueRGB, Options.AccentColor, Library.AccentColor) end
     if Options.OutlineColor then pcall(Options.OutlineColor.SetValueRGB, Options.OutlineColor, Library.OutlineColor) end
end


local function setupManagers(uiSettingsTab, fovManager)
    -- Configure ThemeManager and SaveManager
    ThemeManager:SetLibrary(Library)
    SaveManager:SetLibrary(Library)

    -- **FIX:** Apply Puppy Theme *after* ThemeManager has built its UI elements
    -- but *before* it potentially loads a saved theme.

    -- Configure save settings
    SaveManager:IgnoreThemeSettings() -- Keep ignoring theme settings in saves
    SaveManager:SetIgnoreIndexes({ 'MenuKeybind' })

    -- Set folders for themes and configs
    ThemeManager:SetFolder('PuppyHub') -- Updated folder name
    SaveManager:SetFolder('PuppyHub/Rogue-Lineage') -- Updated folder name

    -- Build configuration and theme sections
    SaveManager:BuildConfigSection(uiSettingsTab)
    ThemeManager:ApplyToTab(uiSettingsTab) 
    
    applyPuppyTheme() 

    
    -- Setup cleanup when script is unloaded
    Library.OnUnload = function()
        print("[Puppy Hub] Unloading...")
        if walkspeedConnection then walkspeedConnection:Disconnect() end -- Disconnect walkspeed listener
        if connMgr then connMgr:disconnectAll() end -- Use disconnectAll for safety
        
        -- NEW: Disable NoFog to restore original settings
        if ModuleInstances.noFog then
            pcall(ModuleInstances.noFog.disable, ModuleInstances.noFog)
        end
        
        print("[Player Hub] Restored original fog settings.")

        -- Destroy modules
        if triggerMonitor then triggerMonitor:destroy() end
        if fovManager then fovManager:destroy() end
        for name, instance in pairs(ModuleInstances) do
            if instance and instance.destroy then
                pcall(instance.destroy, instance) -- Safely call destroy
            elseif instance and instance.disable then
                 pcall(instance.disable, instance) -- Fallback to disable
            end
        end
        ModuleInstances = {} -- Clear table

        print("[Puppy Hub] Unload complete.")
    end
end


-- ========================================
-- MAIN INITIALIZATION
-- ========================================

local function main()
    -- Create main UI components
    local window = createMainWindow()
    local tabs = setupTabs(window)
    
    -- Initialize FOV circle manager
    local fovManager = FOVCircleManager and FOVCircleManager.new()
    if fovManager then
        -- Set up the update callback to pass the autoAim instance
        fovManager:setUpdateCallback(function()
            if ModuleInstances.autoAim then -- Check if autoAim exists
                 fovManager:updateCircle(ModuleInstances.autoAim, connMgr)
            end
        end)
    end
    
    -- Setup UI components
    createPuppyHubTabs(tabs, fovManager) -- Use the new function
    createUISettingsTab(tabs.UISettings)
    setupManagers(tabs.UISettings, fovManager) -- This now applies the theme correctly
    wait(3)
    applyPuppyTheme() 
end

-- Start the script
main()

print("[Puppy Hub] Loaded!")